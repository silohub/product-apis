name: Publish APIs
on:
  push:
    branches:
      - develop2
      - master2
jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout 🛎️
        uses: actions/checkout@v2.3.1

      - name: Git branch name
        id: git-branch-name
        uses: EthanSK/git-branch-name-action@v1

      - name: Replace version
        uses: jacobtomlinson/gha-find-replace@v2
        with:
          find: "version: ${{ env.GIT_BRANCH_NAME }}"
          replace: "version: ${{ env.GIT_BRANCH_NAME }}-${{ github.run_number }}"
          regex: false
          include: "openapi/*.yaml"

      - name: Verify OpenAPI 🔧
        run: |
          npm install
          npm run test
          head -5 openapi/core.yaml
          head -5 openapi/admin.yaml

      - name: Bundle APIs 🔧
        run: |
          npm run bundle --file=core

      - name: Build HTML files 🔧
        run: |
          npm run build --file=core
          cp docs/favicon.png docs/index.html build/

      - name: Deploy 🚀
        uses: JamesIves/github-pages-deploy-action@4.1.5
        with:
          branch: gh-pages
          folder: build
          repository-name: silohub/public-api
          target-folder: ${{ github.ref }}
          token: ${{ secrets.DEPLOY_TOKEN }}